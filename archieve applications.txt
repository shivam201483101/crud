-- PROCEDURE: yono_cstmr.archive_completed_applications()

-- DROP PROCEDURE IF EXISTS yono_cstmr.archive_completed_applications();

CREATE OR REPLACE PROCEDURE yono_cstmr.archive_completed_applications(
	)
LANGUAGE 'plpgsql'
AS $BODY$
DECLARE
    elementCount INTEGER;
BEGIN

SELECT count(*) into elementCount FROM yono_cstmr.cstmr_onbrdng WHERE last_updtd_dt < NOW() - INTERVAL '30 days' and  status in ('055');
RAISE NOTICE 'total elements to archive %',elementCount;

    INSERT INTO yono_cstmr.cstmr_onbrdng_arch
    SELECT * FROM yono_cstmr.cstmr_onbrdng WHERE last_updtd_dt < NOW() - INTERVAL '30 days' and  status in ('055');
RAISE NOTICE 'records moved';

    DELETE FROM yono_cstmr.cstmr_onbrdng
    WHERE last_updtd_dt < NOW() - INTERVAL '30 days' and  status in ('055');
    RAISE NOTICE 'records deleted';

END;
$BODY$;
ALTER PROCEDURE yono_cstmr.archive_completed_applications()
    OWNER TO enterprisedb;
